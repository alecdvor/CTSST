<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> CTS Study Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Place it behind all other content */
        }
        .chapter-checkbox:checked + label, .option-checkbox:checked + label {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        .mode-button.selected, .license-button.selected {
             background-color: #3b82f6;
             color: white;
        }
        .option-btn {
            transition: background-color 0.2s;
        }
        .option-btn.selected {
            background-color: #93c5fd; /* blue-300 */
            border-color: #3b82f6;
        }
        /* Added rule to prevent clicks on answered questions in study mode */
        #options-container.answered .option-btn {
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col min-h-screen">
    <canvas id="bg-canvas"></canvas>
    <main class="w-full flex-grow flex items-center justify-center p-4">
        <div id="license-container" class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 dark:text-white mb-4"> CTS Exam Study Tool </h1>
            <h2 class="text-xl md:text-2xl text-center text-gray-500 dark:text-gray-400 mb-8">Select License Class</h2>
            <div id="license-list" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            </div>
             <button id="view-progress-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-700 transition-colors">
                View Progress
            </button>
        </div>

        <div id="selection-container" class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 hidden">
            <h1 id="selection-header" class="text-2xl md:text-3xl font-bold text-center text-gray-800 dark:text-white mb-6">Choose a Study Mode</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button id="mode-study-btn" class="mode-button w-full text-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-lg font-bold">Study by Chapter</span>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Focus on specific topics.</p>
                </button>
                <button id="mode-exam-btn" class="mode-button w-full text-center p-4 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="text-lg font-bold">Practice Exam</span>
                    <p id="exam-desc" class="text-sm text-gray-500 dark:text-gray-400"></p>
                </button>
            </div>

            <div id="study-options" class="hidden">
                <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Choose one or more chapters to begin.</p>
                <div id="chapter-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6"></div>
                <div class="flex items-center justify-center mb-8">
                    <input type="checkbox" id="randomize-questions" name="randomize" class="hidden option-checkbox" checked>
                    <label for="randomize-questions" class="flex items-center justify-center w-auto px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span>Randomize Questions</span>
                    </label>
                </div>
            </div>

            <div id="exam-options" class="hidden text-center">
                <p id="exam-long-desc" class="text-gray-600 dark:text-gray-300 mb-6"></p>
            </div>

            <button id="start-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 transition-all duration-300 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                Start
            </button>
            <button id="back-to-license-btn" class="w-full mt-4 bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600">Back</button>
        </div>

        <div id="game-container" class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 hidden"></div>

        <div id="score-container" class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 hidden"></div>
        
        <div id="progress-container" class="w-full max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 md:p-8 hidden"></div>
    </main>

    <footer class="w-full text-center p-4 text-sm text-gray-500 dark:text-gray-400 shrink-0">
        <p>
            Made by:  <a href="mailto:alec@alecdvor.me" class="hover:underline text-blue-500">E-mail me to report bugs or connect.</a>
                <br>
            If you found this useful and would like to support my work.
                <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'>    
                </script>
                <script type='text/javascript'>kofiwidget2.init('Support me on Ko-fi', '#72a4f2', 'U7U418BHY8');kofiwidget2.draw();
                </script> 
                </p>
                </footer>


    <script src="questions/cts1_questions.js"></script>
    <script src="questions/cts2_questions.js"></script>
    <script src="questions/cts3_questions.js"></script>
    <script src="questions/cts4_questions.js"></script>
    <script>
        window.addEventListener('load', () => {
        setTimeout(() => { 
            // ----- DATA -----
            // ##### MODIFICATION 1: UPDATED LICENSE_CLASSES OBJECT #####
            const LICENSE_CLASSES = {
                CTS: {
                    prefix: 'cts',
                    passingScore: 80, // Adjusted for a 100-question exam
                    chapters: [
                        { id: 1, title: "Essentials of AV technology", examCount: 35 },
                        { id: 2, title: "Creating AV Solutions", examCount: 30 },
                        { id: 3, title: "Implementing AV Solutions", examCount: 15 },
                        { id: 4, title: "Servicing AV Solutions", examCount: 20 }
                    ]
                },
                CTS_D: {
                    prefix: 'ctsd',
                    passingScore: 80, // Example value, adjust as needed
                    chapters: [
                        { id: 1, title: "Conducting a Needs Assessment", examCount: 19 }, 
                        { id: 2, title: "Collaborating With Other Professional", examCount: 32 },
                        { id: 3, title: "Developing AV Designs", examCount: 62 },
                        { id: 4, title: "Conducting Project Implementation Activities", examCount: 12 }
                    ]
                },
                CTS_I: {
                    prefix: 'ctsi',
                    passingScore: 80, // Example value, adjust as needed
                    chapters: [
                        // { id: 1, title: "...", examCount: 10 },
                        // { id: 2, title: "...", examCount: 15 }
                    ]
                }
            };
            
            const availableClasses = {};

            Object.entries(LICENSE_CLASSES).forEach(([name, config]) => {
                const chapterData = [];
                config.chapters.forEach(ch => {
                    const varName = `${config.prefix}${ch.id}_questions`;
                    if (typeof window[varName] !== 'undefined' && window[varName].questions) {
                        chapterData.push({ ...ch, varName: varName, data: window[varName] });
                    }
                });
                if (chapterData.length > 0) {
                    availableClasses[name] = { ...config, chapters: chapterData };
                }
            });

            // ----- DOM ELEMENT REFERENCES -----
            const licenseContainer = document.getElementById('license-container');
            const licenseList = document.getElementById('license-list');
            const selectionContainer = document.getElementById('selection-container');
            const gameContainer = document.getElementById('game-container');
            const scoreContainer = document.getElementById('score-container');
            const progressContainer = document.getElementById('progress-container');
            const chapterList = document.getElementById('chapter-list');
            const startBtn = document.getElementById('start-btn');
            const randomizeCheckbox = document.getElementById('randomize-questions');
            const modeStudyBtn = document.getElementById('mode-study-btn');
            const modeExamBtn = document.getElementById('mode-exam-btn');
            const studyOptions = document.getElementById('study-options');
            const examOptions = document.getElementById('exam-options');
            const viewProgressBtn = document.getElementById('view-progress-btn');
            const backToLicenseBtn = document.getElementById('back-to-license-btn');
            const selectionHeader = document.getElementById('selection-header');
            const examDesc = document.getElementById('exam-desc');
            const examLongDesc = document.getElementById('exam-long-desc');

            // ----- GLOBAL GAME STATE -----
            let allQuestions = [];
            let userAnswers = [];
            let currentQuestionIndex = 0;
            let chapterScores = {};
            let missedQuestions = [];
            let overallScore = { correct: 0, attempted: 0 };
            let gameMode = null; // 'study' or 'exam'
            let selectedLicense = null;
            let examStartTime = null;
            let timerInterval = null;
            let userProgress = {}; // Will be structured as { General: { ... }, Technician: { ... } }

            // ----- PROGRESS TRACKING & LOCAL STORAGE -----
            function loadProgress() {
                const savedProgress = localStorage.getItem('arlstProgress');
                userProgress = savedProgress ? JSON.parse(savedProgress) : {};

                Object.keys(availableClasses).forEach(className => {
                    if (!userProgress[className]) {
                        userProgress[className] = { examHistory: [], chapterPerformance: {} };
                    }
                    availableClasses[className].chapters.forEach(ch => {
                         if (!userProgress[className].chapterPerformance[ch.id]) {
                            userProgress[className].chapterPerformance[ch.id] = { correct: 0, attempted: 0, title: ch.title };
                        }
                    });
                });
            }

            function saveProgress() {
                localStorage.setItem('arlstProgress', JSON.stringify(userProgress));
            }

            function resetProgress() {
                localStorage.removeItem('arlstProgress');
                userProgress = {};
                loadProgress(); // Re-initialize
                displayProgress(); // Refresh the view
            }

            function displayProgress() {
                licenseContainer.classList.add('hidden');
                selectionContainer.classList.add('hidden');
                let progressHTML = `<h1 class="text-2xl md:text-3xl font-bold text-center mb-6">Your Progress</h1>`;

                Object.entries(userProgress).forEach(([className, classData]) => {
                    progressHTML += `<div class="mb-10"><h2 class="text-2xl font-bold mb-4 text-center border-b pb-2">${className} Class</h2>`;
                    
                    progressHTML += `<div class="mb-8"><h3 class="text-xl font-bold mb-4">Practice Exam History</h3>`;
                    if(classData.examHistory.length > 0){
                         progressHTML += `<div class="overflow-x-auto"><table class="w-full text-left table-auto"><thead><tr class="border-b dark:border-gray-600"><th class="p-2">Date</th><th class="p-2">Score</th><th class="p-2">Result</th><th class="p-2">Time</th></tr></thead><tbody>`;
                        classData.examHistory.slice().reverse().forEach(exam => {
                            progressHTML += `<tr class="border-b dark:border-gray-700"><td class="p-2">${exam.date}</td><td class="p-2">${exam.score}</td><td class="p-2 ${exam.passed ? 'text-green-500' : 'text-red-500'}">${exam.passed ? 'PASS' : 'FAIL'}</td><td class="p-2">${exam.time}</td></tr>`;
                        });
                        progressHTML += `</tbody></table></div>`;
                    } else {
                        progressHTML += `<p class="text-gray-500 dark:text-gray-400">No practice exams taken yet for this class.</p>`;
                    }
                     progressHTML += `</div>`;

                    progressHTML += `<div class="mb-8"><h3 class="text-xl font-bold mb-4">Chapter Performance</h3><div class="space-y-3">`;
                    Object.entries(classData.chapterPerformance).sort((a,b) => a[0] - b[0]).forEach(([chapId, chap]) => {
                        const percentage = chap.attempted === 0 ? 0 : Math.round((chap.correct / chap.attempted) * 100);
                        progressHTML += `<div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-lg">
                                            <span class="font-semibold">Ch ${chapId}: ${chap.title}</span>
                                            <span>${chap.correct} / ${chap.attempted} (${percentage}%)</span>
                                          </div>`;
                    });
                    progressHTML += `</div></div></div>`;
                });


                progressHTML += `<div class="flex flex-col md:flex-row gap-4 mt-8">
                                    <button id="back-to-menu-btn" class="w-full bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600">Back to Menu</button>
                                    <button id="reset-progress-btn" class="w-full bg-red-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700">Reset All Progress</button>
                                 </div>`;

                progressContainer.innerHTML = progressHTML;
                progressContainer.classList.remove('hidden');

                document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                    progressContainer.classList.add('hidden');
                    licenseContainer.classList.remove('hidden');
                });
                document.getElementById('reset-progress-btn').addEventListener('click', resetProgress);
            }


            // ----- INITIALIZATION -----
            function initializeLicenseSelection() {
                licenseList.innerHTML = '';
                Object.keys(availableClasses).forEach(name => {
                    const button = document.createElement('button');
                    button.textContent = name;
                    button.classList.add('license-button', 'w-full', 'text-center', 'p-6', 'rounded-lg', 'border', 'border-gray-300', 'dark:border-gray-600', 'cursor-pointer', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'transition-colors', 'text-lg', 'font-bold');
                    button.addEventListener('click', () => selectLicense(name));
                    licenseList.appendChild(button);
                });
            }

            // ##### MODIFICATION 2: UPDATED selectLicense FUNCTION #####
            function selectLicense(name) {
                selectedLicense = availableClasses[name];
                licenseContainer.classList.add('hidden');
                
                // Calculate the total number of questions by adding up the counts from each chapter
                const totalExamQuestions = selectedLicense.chapters.reduce((total, ch) => total + (ch.examCount || 0), 0);

                // Configure and show mode selection screen
                selectionHeader.textContent = `${name} Class Study`;
                examDesc.textContent = `${totalExamQuestions} questions from selected chapters.`;
                examLongDesc.textContent = `Take a simulated ${name} class exam with ${totalExamQuestions} questions drawn from specific chapters. You need ${selectedLicense.passingScore} correct answers to pass. Your time will be recorded.`;
                
                initializeChapterSelection(selectedLicense.chapters);
                selectionContainer.classList.remove('hidden');
            }

            function initializeChapterSelection(chapters) {
                chapterList.innerHTML = ''; // Clear previous chapters
                chapters.forEach(chapter => {
                    const div = document.createElement('div');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `chapter-${chapter.id}`;
                    input.name = 'chapter';
                    input.value = chapter.id;
                    input.classList.add('hidden', 'chapter-checkbox');

                    const label = document.createElement('label');
                    label.htmlFor = `chapter-${chapter.id}`;
                    label.innerHTML = `<span class="font-bold">Chapter ${chapter.id}</span><span class="text-xs mt-1">${chapter.title}</span>`;
                    label.classList.add('flex', 'flex-col', 'items-center', 'justify-center', 'h-full', 'w-full', 'text-center', 'p-2', 'rounded-lg', 'border', 'border-gray-300', 'dark:border-gray-600', 'cursor-pointer', 'hover:bg-gray-100', 'dark:hover:bg-gray-700', 'transition-colors');
                    
                    div.appendChild(input);
                    div.appendChild(label);
                    chapterList.appendChild(div);
                });
            }
            
            // ----- DOM-BASED GAME LOGIC -----
            function displayQuestion() {
                if (gameMode === 'study' && currentQuestionIndex >= allQuestions.length) {
                    displayFinalScore();
                    return;
                }
                gameContainer.innerHTML = '';
                const question = allQuestions[currentQuestionIndex];

                let gameHTML = `<div class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                                    <p>Question ${currentQuestionIndex + 1} of ${allQuestions.length}</p>
                                    <div class="text-right">`;
                if (gameMode === 'study') {
                    gameHTML += `<p id="live-score">Score: ${overallScore.correct} / ${overallScore.attempted}</p>`;
                }
                if (gameMode === 'exam') {
                    gameHTML += `<p id="timer">Time: 00:00</p>`;
                }
                gameHTML += `</div></div>`;
                
                gameHTML += `<div class="my-4">`;
                if(gameMode === 'study'){ gameHTML += `<p class="text-sm text-gray-500 dark:text-gray-400 mb-2">ID: ${question.id || 'N/A'}</p>`; }
                gameHTML += `<p class="text-lg text-gray-800 dark:text-gray-200">${question.question || '[Missing Question Text]'}</p></div>`;
                if (question.image) { gameHTML += `<div class="my-4 flex justify-center"><img src="img/${question.image}" alt="Question Figure" class="max-w-full h-auto rounded-lg"></div>`; }
                
                gameHTML += `<div id="options-container" class="space-y-3">`;
                (question.options || []).forEach(optionText => {
                    const isSelected = gameMode === 'exam' && userAnswers[currentQuestionIndex] === optionText;
                    gameHTML += `<button class="option-btn block w-full text-left p-4 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-blue-100 dark:hover:bg-blue-900 ${isSelected ? 'selected' : ''}">${optionText || ''}</button>`;
                });
                gameHTML += `</div>`;

                // Navigation for Exam Mode
                if (gameMode === 'exam') {
                    gameHTML += `<div class="mt-6 flex justify-between items-center">
                                    <button id="prev-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 disabled:bg-gray-400" ${currentQuestionIndex === 0 ? 'disabled' : ''}>Previous</button>
                                    <div id="submit-container"></div>
                                    <button id="next-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 disabled:bg-gray-400" ${currentQuestionIndex === allQuestions.length - 1 ? 'disabled' : ''}>Next</button>
                                 </div>`;
                }

                gameContainer.innerHTML = gameHTML;

                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleOptionClick(btn, question));
                });

                if (gameMode === 'exam') {
                    document.getElementById('prev-btn').addEventListener('click', () => {
                        if (currentQuestionIndex > 0) {
                            currentQuestionIndex--;
                            displayQuestion();
                        }
                    });
                    document.getElementById('next-btn').addEventListener('click', () => {
                        if (currentQuestionIndex < allQuestions.length - 1) {
                            currentQuestionIndex++;
                            displayQuestion();
                        }
                    });
                    checkExamCompletion();
                }
            }

            function handleOptionClick(selectedButton, question) {
                if (gameMode === 'study') {
                    document.getElementById('options-container').classList.add('answered');
                    
                    const buttons = document.querySelectorAll('.option-btn');
                    const selectedAnswer = selectedButton.textContent;
                    const correctAnswer = question.answer;
                    const licenseName = Object.keys(availableClasses).find(key => availableClasses[key] === selectedLicense);
                    const sourceChapter = question.sourceChapter;


                    overallScore.attempted++;
                    chapterScores[question.sourceChapter].attempted++;
                    userProgress[licenseName].chapterPerformance[sourceChapter].attempted++;

                    if (selectedAnswer === correctAnswer) {
                        overallScore.correct++;
                        chapterScores[question.sourceChapter].correct++;
                         userProgress[licenseName].chapterPerformance[sourceChapter].correct++;
                        selectedButton.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-blue-100', 'dark:hover:bg-blue-900');
                        selectedButton.classList.add('bg-green-500', 'text-white');
                    } else {
                        missedQuestions.push({ question: question.question, yourAnswer: selectedAnswer, correctAnswer: correctAnswer, id: question.id });
                        selectedButton.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-blue-100', 'dark:hover:bg-blue-900');
                        selectedButton.classList.add('bg-red-500', 'text-white');
                        buttons.forEach(b => { 
                            if (b.textContent === correctAnswer) {
                                b.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'hover:bg-blue-100', 'dark:hover:bg-blue-900');
                                b.classList.add('bg-green-500', 'text-white');
                            }
                        });
                    }

                    saveProgress();

                    document.getElementById('live-score').textContent = `Score: ${overallScore.correct} / ${overallScore.attempted}`;
                    
                    const navContainer = document.createElement('div');
                    navContainer.classList.add('w-full', 'mt-6', 'flex', 'gap-4', 'flex-col', 'sm:flex-row');

                    const homeBtn = document.createElement('button');
                    homeBtn.textContent = 'Home';
                    homeBtn.classList.add('w-full', 'sm:w-1/3', 'bg-gray-500', 'text-white', 'font-bold', 'py-3', 'px-8', 'rounded-lg', 'hover:bg-gray-600');
                    homeBtn.addEventListener('click', () => location.reload());

                    const nextBtn = document.createElement('button');
                    nextBtn.classList.add('w-full', 'sm:w-2/3', 'bg-blue-600', 'text-white', 'font-bold', 'py-3', 'px-8', 'rounded-lg', 'hover:bg-blue-700');
                    
                    if (currentQuestionIndex >= allQuestions.length - 1) {
                         nextBtn.textContent = 'Finish Session';
                    } else {
                        nextBtn.textContent = 'Next Question';
                    }
                    
                    nextBtn.addEventListener('click', () => { 
                        currentQuestionIndex++; 
                        displayQuestion(); 
                    });
                    
                    navContainer.appendChild(homeBtn);
                    navContainer.appendChild(nextBtn);
                    gameContainer.appendChild(navContainer);

                } else { // Exam mode
                    userAnswers[currentQuestionIndex] = selectedButton.textContent;
                    document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                    selectedButton.classList.add('selected');
                    checkExamCompletion();
                }
            }

            function checkExamCompletion() {
                const allAnswered = !userAnswers.includes(null);
                const submitContainer = document.getElementById('submit-container');
                if (allAnswered && submitContainer) {
                    submitContainer.innerHTML = `<button id="grade-exam-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Grade Exam</button>`;
                    document.getElementById('grade-exam-btn').addEventListener('click', gradeExam);
                } else if(submitContainer) {
                    submitContainer.innerHTML = ``;
                }
            }
            
            function gradeExam() {
                allQuestions.forEach((question, index) => {
                    const userAnswer = userAnswers[index];
                    const correctAnswer = question.answer;
                    overallScore.attempted++;
                    if(userAnswer === correctAnswer) {
                        overallScore.correct++;
                    } else {
                        missedQuestions.push({ question: question.question, yourAnswer: userAnswer, correctAnswer: correctAnswer, id: question.id });
                    }
                });
                displayFinalScore();
            }

            function updateTimer() {
                const timerEl = document.getElementById('timer');
                if(!timerEl) return;
                const elapsedMs = new Date() - examStartTime;
                const seconds = Math.floor((elapsedMs / 1000) % 60).toString().padStart(2, '0');
                const minutes = Math.floor(elapsedMs / 60000).toString().padStart(2, '0');
                timerEl.textContent = `Time: ${minutes}:${seconds}`;
            }

            // ##### MODIFICATION 3: UPDATED startGame FUNCTION #####
            function startGame() {
                allQuestions = []; currentQuestionIndex = 0; missedQuestions = []; chapterScores = {};
                overallScore = { correct: 0, attempted: 0 }; clearInterval(timerInterval);
                if (gameMode === 'study') {
                    const selectedChapters = Array.from(document.querySelectorAll('input[name="chapter"]:checked')).map(cb => parseInt(cb.value));
                    if (selectedChapters.length === 0) return;
                    selectedLicense.chapters.forEach(ch => {
                        if (selectedChapters.includes(ch.id)) {
                            chapterScores[ch.id] = { correct: 0, attempted: 0 };
                            ch.data.questions.forEach(q => allQuestions.push({ ...q, sourceChapter: ch.id }));
                        }
                    });
                    if (randomizeCheckbox.checked) allQuestions.sort(() => Math.random() - 0.5);
                } else if (gameMode === 'exam') {
                    examStartTime = new Date();
                    let examPool = []; // Create an empty array to hold the exam questions

                    // Go through each chapter defined for the selected license
                    selectedLicense.chapters.forEach(ch => {
                        // Check if the chapter has questions and a specified exam count
                        if (ch.data && ch.data.questions && ch.examCount > 0) {
                            // Shuffle that chapter's questions randomly
                            const shuffledChapterQuestions = ch.data.questions.sort(() => Math.random() - 0.5);
                            // Take the specified number of questions from the top
                            const selectedQuestions = shuffledChapterQuestions.slice(0, ch.examCount);
                            // Add these selected questions to our main exam pool
                            examPool.push(...selectedQuestions);
                        }
                    });

                    // Shuffle the final combined pool so questions from different chapters are mixed
                    allQuestions = examPool.sort(() => Math.random() - 0.5);
                    
                    userAnswers = new Array(allQuestions.length).fill(null);
                    timerInterval = setInterval(updateTimer, 1000);
                }
                selectionContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                displayQuestion();
            }

            function displayFinalScore() {
                gameContainer.innerHTML = ''; gameContainer.classList.add('hidden'); clearInterval(timerInterval);
                let timeString = ''; let passed = false;
                const licenseName = Object.keys(availableClasses).find(key => availableClasses[key] === selectedLicense);

                if (gameMode === 'exam') {
                    const elapsedMs = new Date() - examStartTime;
                    const seconds = Math.floor((elapsedMs / 1000) % 60).toString().padStart(2, '0');
                    const minutes = Math.floor(elapsedMs / 60000);
                    timeString = `${minutes}m ${seconds}s`;
                    passed = overallScore.correct >= selectedLicense.passingScore;
                    userProgress[licenseName].examHistory.push({ date: new Date().toLocaleDateString(), score: `${overallScore.correct} / ${allQuestions.length}`, passed: passed, time: timeString });
                    saveProgress();
                }

                let scoreHTML = ``;
                if(gameMode === 'exam'){
                    scoreHTML += `<h1 class="text-3xl font-bold text-center mb-2">Practice Exam Complete!</h1><p class="text-center text-lg mb-6 ${passed ? 'text-green-500' : 'text-red-500'} font-semibold">${passed ? 'Result: PASS' : 'Result: FAIL'}</p>`;
                    scoreHTML += `<div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 text-center"><h2 class="text-xl font-bold">Final Score</h2><p class="text-3xl font-light mt-2">${overallScore.correct} / ${allQuestions.length}</p><p class="text-md text-gray-500 dark:text-gray-400 mt-2">Time Taken: ${timeString}</p></div>`;
                } else {
                    scoreHTML = `<h1 class="text-2xl md:text-3xl font-bold text-center mb-6">Study Session Complete!</h1>`;
                    const percentage = allQuestions.length === 0 ? 0 : Math.round((overallScore.correct / allQuestions.length) * 100);
                    scoreHTML += `<div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6 text-center"><h2 class="text-xl font-bold">Overall Score</h2><p class="text-3xl font-light mt-2">${overallScore.correct} / ${allQuestions.length} (${percentage}%)</p></div>`;
                    const selectedChapterIds = Object.keys(chapterScores);
                    if (selectedChapterIds.length > 1) {
                         scoreHTML += `<h2 class="text-xl font-bold mb-4">Session Chapter Breakdown</h2><div class="space-y-3 mb-6">`;
                        for (const chapterId of selectedChapterIds) {
                            const score = chapterScores[chapterId];
                            const chapInfo = selectedLicense.chapters.find(ch => ch.id == chapterId);
                            const chapPercentage = score.attempted === 0 ? 0 : Math.round((score.correct / score.attempted) * 100);
                            scoreHTML += `<div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-lg"><span class="font-semibold">Chapter ${chapterId}: ${chapInfo.title}</span><span>${score.correct} / ${score.attempted} (${chapPercentage}%)</span></div>`;
                        }
                        scoreHTML += `</div>`;
                    }
                }

                if (missedQuestions.length > 0) {
                    scoreHTML += `<h2 class="text-xl font-bold mb-4">Review Missed Questions</h2><div class="space-y-4">`;
                    missedQuestions.forEach(q => {
                        scoreHTML += `<div class="bg-red-100 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-r-lg"><p class="font-semibold text-gray-800 dark:text-gray-200">${q.id}: ${q.question}</p><p class="mt-2 text-red-700 dark:text-red-400"><span class="font-bold">Your Answer:</span> ${q.yourAnswer}</p><p class="mt-1 text-green-700 dark:text-green-400"><span class="font-bold">Correct Answer:</span> ${q.correctAnswer}</p></div>`;
                    });
                    scoreHTML += `</div>`;
                }
                scoreHTML += `<button id="restart-btn" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700">Return to Main Menu</button>`;
                scoreContainer.innerHTML = scoreHTML;
                scoreContainer.classList.remove('hidden');
                document.getElementById('restart-btn').addEventListener('click', () => location.reload());
            }

            // ----- EVENT LISTENERS -----
            function selectMode(mode) {
                gameMode = mode; startBtn.disabled = false;
                startBtn.textContent = mode === 'study' ? 'Start Study Session' : 'Start Practice Exam';
                if (mode === 'study') {
                    modeStudyBtn.classList.add('selected'); modeExamBtn.classList.remove('selected');
                    studyOptions.classList.remove('hidden'); examOptions.classList.add('hidden');
                    startBtn.disabled = document.querySelectorAll('input[name="chapter"]:checked').length === 0;
                } else {
                    modeExamBtn.classList.add('selected'); modeStudyBtn.classList.remove('selected');
                    examOptions.classList.remove('hidden'); studyOptions.classList.add('hidden');
                }
            }
            
            modeStudyBtn.addEventListener('click', () => selectMode('study'));
            modeExamBtn.addEventListener('click', () => selectMode('exam'));
            chapterList.addEventListener('change', () => { if(gameMode === 'study') { startBtn.disabled = document.querySelectorAll('input[name="chapter"]:checked').length === 0; } });
            startBtn.addEventListener('click', startGame);
            viewProgressBtn.addEventListener('click', displayProgress);
            backToLicenseBtn.addEventListener('click', () => location.reload());

            // ----- START THE APP -----
            
            function main() {
                loadProgress();
                initializeLicenseSelection();
            }

            // ##### MODIFICATION 4: UPDATED waitForDataAndInit FUNCTION #####
            function waitForDataAndInit() {
                // Check for the variable from the first CTS class question file.
                if (typeof window.cts1_questions !== 'undefined') {
                    main(); // If it exists, run the main app logic.
                } else {
                    setTimeout(waitForDataAndInit, 100); // Otherwise, check again in 100ms.
                }
            }
            
            waitForDataAndInit(); // Start the process.

        }, 50);
        });
    </script>


    <script>
    window.addEventListener('load', () => {
        if (typeof THREE === 'undefined') {
            console.error('Three.js library not loaded.');
            return;
        }

        let scene, camera, renderer, cubes;
        let mouseX = 0, mouseY = 0;

        const canvas = document.getElementById('bg-canvas');
        if (!canvas) return;
        
        // 1. Scene Setup
        scene = new THREE.Scene();
        
        // 2. Camera Setup
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 30;

        // 3. Renderer Setup
        renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 0); // Transparent background

        // 4. Create Cubes
        cubes = [];
        const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
        const material = new THREE.MeshLambertMaterial({
            color: 0x8cb4ff, // A light, subtle blue
            wireframe: true,
            transparent: true,
            opacity: 0.3
        });

        for (let i = 0; i < 100; i++) {
            const cube = new THREE.Mesh(geometry, material);
            cube.position.x = (Math.random() - 0.5) * 100;
            cube.position.y = (Math.random() - 0.5) * 100;
            cube.position.z = (Math.random() - 0.5) * 100;
            cube.rotation.x = Math.random() * 2 * Math.PI;
            cube.rotation.y = Math.random() * 2 * Math.PI;
            scene.add(cube);
            cubes.push(cube);
        }

        // 5. Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1).normalize();
        scene.add(directionalLight);

        // 6. Mouse Move Listener
        function onMouseMove(event) {
            mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
        }
        window.addEventListener('mousemove', onMouseMove, false);

        // 7. Window Resize Listener
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize, false);

        // 8. Animation Loop
        function animate() {
            requestAnimationFrame(animate);

            // Animate cubes
            cubes.forEach(cube => {
                cube.rotation.x += 0.001;
                cube.rotation.y += 0.0015;
            });

            // Move camera based on mouse position
            camera.position.x += (mouseX * 5 - camera.position.x) * 0.05;
            camera.position.y += (mouseY * 5 - camera.position.y) * 0.05;
            camera.lookAt(scene.position);

            renderer.render(scene, camera);
        }

        animate();
    });
    </script>
    
</body>
</html>
